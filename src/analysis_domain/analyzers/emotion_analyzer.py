"""
–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ–∫—Ä–∞—Å–∫–∏ —Ç–µ–∫—Å—Ç–∞
"""
import json
from typing import Optional, Dict, Any
from loguru import logger

from src.text_domain.entities.base_text import BaseText
from src.text_domain.entities.chunking_strategy import ChunkingStrategy
from ..entities.base_analyzer import BaseAnalyzer
from ..entities.analysis_result import AnalysisResult
from src.common.types import AnalysisMode
from src.common.exceptions import AnalysisError


class EmotionAnalyzer(BaseAnalyzer):
    """
    –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ–∫—Ä–∞—Å–∫–∏ –∏ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞
    """

    def __init__(self, llm_service=None):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è"""
        self.llm_service = llm_service

    @property
    def name(self) -> str:
        return "emotion"

    @property
    def display_name(self) -> str:
        return "–ê–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–π"

    @property
    def description(self) -> str:
        return "–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –æ–∫—Ä–∞—Å–∫—É –∏ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞"

    @property
    def requires_llm(self) -> bool:
        return True

    async def analyze(
        self,
        text: BaseText,
        mode: AnalysisMode = AnalysisMode.FULL_TEXT,
        chunking_strategy: Optional[ChunkingStrategy] = None,
        context: Optional[Dict[str, Any]] = None
    ) -> AnalysisResult:
        """–ê–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–π"""
        try:
            import time
            start_time = time.time()

            content = await text.get_content()
            analysis_text = content[:3000]

            # –û–±–æ–≥–∞—â–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏ —ç–º–æ—Ü–∏–π –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
            emotion_dictionaries = {
                "—Ä–∞–¥–æ—Å—Ç—å": [
                    "—Ä–∞–¥–æ—Å—Ç—å", "—Å—á–∞—Å—Ç—å–µ", "–≤–µ—Å–µ–ª—å–µ", "–≤–æ—Å—Ç–æ—Ä–≥", "–ª–∏–∫–æ–≤–∞–Ω–∏–µ", "–±–ª–∞–∂–µ–Ω—Å—Ç–≤–æ", "—ç–π—Ñ–æ—Ä–∏—è",
                    "—Å–º–µ—Ö", "—É–ª—ã–±–∫–∞", "—Ö–æ—Ö–æ—Ç", "—Å–º–µ—è—Ç—å—Å—è", "—É–ª—ã–±–∞—Ç—å—Å—è", "—Ä–∞–¥–æ–≤–∞—Ç—å—Å—è", "–≤–µ—Å–µ–ª–∏—Ç—å—Å—è",
                    "—Å—á–∞—Å—Ç–ª–∏–≤—ã–π", "–≤–µ—Å—ë–ª—ã–π", "—Ä–∞–¥–æ—Å—Ç–Ω—ã–π", "–¥–æ–≤–æ–ª—å–Ω—ã–π", "–≤–æ—Å—Ç–æ—Ä–∂–µ–Ω–Ω—ã–π", "–ª–∏–∫—É—é—â–∏–π",
                    "–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ", "–∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ", "–æ—Ç–ª–∏—á–Ω–æ", "–≤–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ", "—á—É–¥–µ—Å–Ω–æ", "–ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ"
                ],
                "–≥—Ä—É—Å—Ç—å": [
                    "–≥—Ä—É—Å—Ç—å", "–ø–µ—á–∞–ª—å", "—Ç–æ—Å–∫–∞", "–º–µ–ª–∞–Ω—Ö–æ–ª–∏—è", "—Å–∫–æ—Ä–±—å", "–≥–æ—Ä–µ", "—É–Ω—ã–Ω–∏–µ",
                    "–ø–ª–∞—á", "—Å–ª—ë–∑—ã", "—Ä—ã–¥–∞–Ω–∏–µ", "–ø–ª–∞–∫–∞—Ç—å", "—Ä—ã–¥–∞—Ç—å", "–≥—Ä—É—Å—Ç–∏—Ç—å", "–ø–µ—á–∞–ª–∏—Ç—å—Å—è",
                    "–≥—Ä—É—Å—Ç–Ω—ã–π", "–ø–µ—á–∞–ª—å–Ω—ã–π", "—É–Ω—ã–ª—ã–π", "—Å–∫–æ—Ä–±–Ω—ã–π", "—Ç–æ—Å–∫–ª–∏–≤—ã–π", "–º–µ–ª–∞–Ω—Ö–æ–ª–∏—á–Ω—ã–π",
                    "–ø–ª–æ—Ö–æ", "—É–∂–∞—Å–Ω–æ", "–ø–µ—á–∞–ª—å–Ω–æ", "–∂–∞–ª—å", "–∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é", "—É–≤—ã"
                ],
                "–≥–Ω–µ–≤": [
                    "–≥–Ω–µ–≤", "–∑–ª–æ—Å—Ç—å", "—è—Ä–æ—Å—Ç—å", "–±–µ—à–µ–Ω—Å—Ç–≤–æ", "–Ω–µ–≥–æ–¥–æ–≤–∞–Ω–∏–µ", "–≤–æ–∑–º—É—â–µ–Ω–∏–µ", "—Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ",
                    "–∫—Ä–∏–∫", "—Ä—É–≥–∞–Ω—å", "—Å—Å–æ—Ä–∞", "–∫—Ä–∏—á–∞—Ç—å", "—Ä—É–≥–∞—Ç—å—Å—è", "–∑–ª–∏—Ç—å—Å—è", "–±–µ—Å–∏—Ç—Å—è",
                    "–∑–ª–æ–π", "—Å–µ—Ä–¥–∏—Ç—ã–π", "—è—Ä–æ—Å—Ç–Ω—ã–π", "—Ä–∞–∑—ä—è—Ä—ë–Ω–Ω—ã–π", "–≤–æ–∑–º—É—â—ë–Ω–Ω—ã–π", "—Ä–∞–∑–¥—Ä–∞–∂—ë–Ω–Ω—ã–π",
                    "–Ω–µ–Ω–∞–≤–∏–∂—É", "–ø—Ä–æ–∫–ª—è—Ç—å–µ", "—á—ë—Ä—Ç", "–¥—å—è–≤–æ–ª", "–±–µ—Å–∏—Ç", "—Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç"
                ],
                "—Å—Ç—Ä–∞—Ö": [
                    "—Å—Ç—Ä–∞—Ö", "—É–∂–∞—Å", "–∏—Å–ø—É–≥", "—Ç—Ä–µ–≤–æ–≥–∞", "–ø–∞–Ω–∏–∫–∞", "–±–æ—è–∑–Ω—å", "—Ñ–æ–±–∏—è",
                    "–¥—Ä–æ–∂—å", "–∫—Ä–∏–∫", "–≤–æ–ø–ª—å", "–±–æ—è—Ç—å—Å—è", "–ø—É–≥–∞—Ç—å—Å—è", "–¥—Ä–æ–∂–∞—Ç—å", "—Ç—Ä—è—Å—Ç–∏—Å—å",
                    "—Å—Ç—Ä–∞—à–Ω—ã–π", "—É–∂–∞—Å–Ω—ã–π", "–ø—É–≥–∞—é—â–∏–π", "—Ç—Ä–µ–≤–æ–∂–Ω—ã–π", "–∂—É—Ç–∫–∏–π", "–∫–æ—à–º–∞—Ä–Ω—ã–π",
                    "–±–æ–∂–µ", "–ø–æ–º–æ–≥–∏—Ç–µ", "—Å–ø–∞—Å–∏—Ç–µ", "—É–∂–∞—Å", "–∫–æ—à–º–∞—Ä", "–±–µ–¥–∞"
                ],
                "—É–¥–∏–≤–ª–µ–Ω–∏–µ": [
                    "—É–¥–∏–≤–ª–µ–Ω–∏–µ", "–∏–∑—É–º–ª–µ–Ω–∏–µ", "–ø–æ—Ä–∞–∂–µ–Ω–∏–µ", "—à–æ–∫", "–æ—Å—Ç–æ–ª–±–µ–Ω–µ–Ω–∏–µ", "–æ—à–µ–ª–æ–º–ª–µ–Ω–∏–µ",
                    "–æ—Ö", "–∞—Ö", "–æ–≥–æ", "–≤–∞—É", "—É–¥–∏–≤–ª—è—Ç—å—Å—è", "–ø–æ—Ä–∞–∂–∞—Ç—å—Å—è", "–∏–∑—É–º–ª—è—Ç—å—Å—è",
                    "—É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–π", "–ø–æ—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–π", "–∏–∑—É–º–∏—Ç–µ–ª—å–Ω—ã–π", "—à–æ–∫–∏—Ä—É—é—â–∏–π", "–Ω–µ–≤–µ—Ä–æ—è—Ç–Ω—ã–π",
                    "–Ω–µ—É–∂–µ–ª–∏", "–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ", "–Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å", "–≤–æ—Ç —ç—Ç–æ –¥–∞", "–Ω–∞–¥–æ –∂–µ"
                ],
                "–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ": [
                    "–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ", "–æ–º–µ—Ä–∑–µ–Ω–∏–µ", "–±—Ä–µ–∑–≥–ª–∏–≤–æ—Å—Ç—å", "—Ç–æ—à–Ω–æ—Ç–∞", "–º–µ—Ä–∑–æ—Å—Ç—å",
                    "—Ñ—É", "–≥–∞–¥–æ—Å—Ç—å", "–º–µ—Ä–∑–∫–æ", "–ø—Ä–æ—Ç–∏–≤–Ω–æ", "—Ç–æ—à–Ω–∏—Ç", "–≤–æ—Ä–æ—Ç–∏—Ç",
                    "–ø—Ä–æ—Ç–∏–≤–Ω—ã–π", "–º–µ—Ä–∑–∫–∏–π", "–≥–∞–¥–∫–∏–π", "–æ—Ç–≤—Ä–∞—Ç–∏—Ç–µ–ª—å–Ω—ã–π", "–æ–º–µ—Ä–∑–∏—Ç–µ–ª—å–Ω—ã–π",
                    "–Ω–µ –≤—ã–Ω–æ—à—É", "—Ç–µ—Ä–ø–µ—Ç—å –Ω–µ –º–æ–≥—É", "–¥–æ —Ç–æ—à–Ω–æ—Ç—ã"
                ],
                "–ø—Ä–µ–∑—Ä–µ–Ω–∏–µ": [
                    "–ø—Ä–µ–∑—Ä–µ–Ω–∏–µ", "–ø—Ä–µ–Ω–µ–±—Ä–µ–∂–µ–Ω–∏–µ", "–≤—ã—Å–æ–∫–æ–º–µ—Ä–∏–µ", "–Ω–∞–¥–º–µ–Ω–Ω–æ—Å—Ç—å", "—Å–Ω–æ–±–∏–∑–º",
                    "—Ñ—ã—Ä–∫–∞—Ç—å", "–º–æ—Ä—â–∏—Ç—å—Å—è", "–ø—Ä–µ–∑–∏—Ä–∞—Ç—å", "–ø—Ä–µ–Ω–µ–±—Ä–µ–≥–∞—Ç—å", "–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å",
                    "–ø—Ä–µ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π", "–ø—Ä–µ–Ω–µ–±—Ä–µ–∂–∏—Ç–µ–ª—å–Ω—ã–π", "–≤—ã—Å–æ–∫–æ–º–µ—Ä–Ω—ã–π", "–Ω–∞–¥–º–µ–Ω–Ω—ã–π", "—Å–Ω–æ–±–∏—Å—Ç—Å–∫–∏–π",
                    "–Ω–∏—á—Ç–æ–∂–µ—Å—Ç–≤–æ", "–º–µ–ª–æ—á—å", "–ø–ª–µ–≤–∞—Ç—å", "–Ω–∞–ø–ª–µ–≤–∞—Ç—å"
                ]
            }

            # –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–π
            emotion_scores = {}
            total_words = len(analysis_text.split())

            for emotion, words in emotion_dictionaries.items():
                count = sum(analysis_text.lower().count(word) for word in words)
                emotion_scores[emotion] = round(count / max(total_words, 1) * 10, 3)  # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ–º–∏–Ω–∏—Ä—É—é—â—É—é —ç–º–æ—Ü–∏—é
            dominant_emotion = max(emotion_scores, key=emotion_scores.get) if emotion_scores else "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è"

            # –û–±—â–∏–π —Ç–æ–Ω (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π/–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π/–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π)
            positive_score = emotion_scores.get("—Ä–∞–¥–æ—Å—Ç—å", 0)
            negative_score = sum([
                emotion_scores.get("–≥—Ä—É—Å—Ç—å", 0),
                emotion_scores.get("–≥–Ω–µ–≤", 0),
                emotion_scores.get("—Å—Ç—Ä–∞—Ö", 0),
                emotion_scores.get("–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ", 0)
            ])

            if positive_score > negative_score * 1.2:
                sentiment = "–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π"
                sentiment_score = 0.6 + (positive_score - negative_score) * 0.1
            elif negative_score > positive_score * 1.2:
                sentiment = "–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π"
                sentiment_score = 0.4 - (negative_score - positive_score) * 0.1
            else:
                sentiment = "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π"
                sentiment_score = 0.5

            result_data = {
                "dominant_emotion": dominant_emotion,
                "emotions": emotion_scores,
                "sentiment": sentiment,
                "sentiment_score": max(0, min(1, sentiment_score)),
                "analysis_method": "keyword_based"
            }

            execution_time = (time.time() - start_time) * 1000

            result = AnalysisResult(
                text_id=text.id,
                analyzer_name=self.name,
                data=result_data,
                execution_time_ms=execution_time,
                mode=mode.value,
            )

            result.interpretation = self.interpret_results(result)
            return result

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —ç–º–æ—Ü–∏–π: {e}")
            raise AnalysisError(f"Emotion analysis failed: {e}")

    def interpret_results(self, result: AnalysisResult) -> str:
        """–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è"""
        data = result.data
        dominant = data.get("dominant_emotion", "–Ω/–¥")
        sentiment = data.get("sentiment", "–Ω/–¥")
        emotions = data.get("emotions", {})

        lines = [
            f"üòä –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:",
            f"–î–æ–º–∏–Ω–∏—Ä—É—é—â–∞—è —ç–º–æ—Ü–∏—è: {dominant}",
            f"–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å: {sentiment}",
            "\n–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–º–æ—Ü–∏–π:"
        ]

        for emotion, score in sorted(emotions.items(), key=lambda x: x[1], reverse=True):
            lines.append(f"- {emotion}: {score:.0%}")

        return "\n".join(lines)
